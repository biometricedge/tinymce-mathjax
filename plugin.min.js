tinymce.PluginManager.add("mathjax",(function(t,e){let n=t.settings.mathjax.className||"math-tex",a=n+"-original",l=t.settings.mathjax.symbols||{start:"\\(",end:"\\)"},i=t.settings.mathjax.lib||null,o=[(t.settings.mathjax.configUrl||e+"/config.js")+"?class="+a];i&&o.push(i),t.on("init",(function(){let e=t.getDoc().getElementsByTagName("script");for(let n=0;n<o.length;n++){let a=t.dom.uniqueId(),l=t.dom.create("script",{id:a,type:"text/javascript",src:o[n]}),i=!1;for(let t=0;t<e.length;t++)if(e[t].src==l.src){i=!0;break}i||t.getDoc().getElementsByTagName("head")[0].appendChild(l)}})),t.on("GetContent",(function(e){let a=t.dom.create("div");a.innerHTML=e.content;let l=a.querySelectorAll("."+n);for(let t=0;t<l.length;t++){let e=l[t].querySelectorAll("span");for(let t=0;t<e.length;t++)e[t].remove();let n=l[t].getAttribute("data-latex");l[t].removeAttribute("contenteditable"),l[t].removeAttribute("style"),l[t].removeAttribute("data-latex"),l[t].innerHTML=n}e.content=a.innerHTML}));let s=function(e){if(2!=e.childNodes.length){e.setAttribute("contenteditable",!1),e.style.cursor="pointer";let n=e.getAttribute("data-latex")||e.innerHTML;e.setAttribute("data-latex",n),e.innerHTML="";let l=t.dom.create("span");l.innerHTML=n,l.classList.add(a),e.appendChild(l);let i=t.dom.create("span");i.classList.add("dummy"),i.innerHTML="dummy",i.setAttribute("hidden","hidden"),e.appendChild(i)}};t.on("BeforeSetContent",(function(e){let a=t.dom.create("div");a.innerHTML=e.content;let l=a.querySelectorAll("."+n);for(let t=0;t<l.length;t++)s(l[t]);e.content=a.innerHTML})),t.on("SetContent",(function(e){const n=t.getDoc().defaultView;n&&n.MathJax&&(n.MathJax.startup.getComponents(),n.MathJax.typeset())})),t.on("Change",(function(e){if(elements=t.dom.getRoot().querySelectorAll("."+n),elements.length){for(let t=0;t<elements.length;t++)s(elements[t]);const e=t.getDoc().defaultView;e&&e.MathJax&&(e.MathJax.startup.getComponents(),e.MathJax.typeset())}})),t.ui.registry.addToggleButton("mathjax",{text:"Î£",tooltip:"Mathjax",onAction:function(){let e,a=t.selection.getNode();a.classList.contains(n)&&(e=a),r(e)},onSetup:function(e){return t.selection.selectorChangedWithUnbind("."+n,e.setActive).unbind}}),t.on("click",(function(t){let e=t.target.closest("."+n);e&&r(e)}));let r=function(e){let i=t.id+"_"+t.dom.uniqueId(),r="";e&&(latex_attribute=e.getAttribute("data-latex"),latex_attribute.length>=(l.start+l.end).length&&(r=latex_attribute.substr(l.start.length,latex_attribute.length-(l.start+l.end).length))),t.windowManager.open({title:"Mathjax",width:600,height:300,body:{type:"panel",items:[{type:"textarea",name:"title",label:"LaTex"},{type:"htmlpanel",html:'<div style="text-align:right"><a href="https://wikibooks.org/wiki/LaTeX/Mathematics" target="_blank" style="font-size:small">LaTex</a></div>'},{type:"htmlpanel",html:'<iframe id="'+i+'" style="width: 100%; min-height: 50px;"></iframe>'}]},buttons:[{type:"submit",text:"OK"}],onSubmit:function(a){let l=a.getData().title.trim();if(e)e.innerHTML="",e.setAttribute("data-latex",h(l)),s(e);else{let e=t.getDoc().createElement("span");e.innerHTML=h(l),e.classList.add(n),s(e),t.insertContent(e.outerHTML)}const i=t.getDoc().defaultView;i&&i.MathJax&&(i.MathJax.startup.getComponents(),i.MathJax.typeset()),a.close()},onChange:function(t){var e=t.getData().title.trim();e!=r&&(p(e,document.getElementById(i)),r=e)},initialData:{title:r}});let c=document.getElementById(i),d=c.contentWindow||c.contentDocument.document||c.contentDocument,u=d.document,m=u.getElementsByTagName("head")[0],g=u.getElementsByTagName("body")[0],h=function(t,e){return e||(e=l),e.start+" "+t+" "+e.end},p=function(t){let e=d.MathJax,n=g.querySelector("div");n||(n=u.createElement("div"),n.classList.add(a),g.appendChild(n)),n.innerHTML=h(t,{start:"$$",end:"$$"}),e&&e.startup&&(e.startup.getComponents(),e.typeset())};p(r);for(let t=0;t<o.length;t++){let e=d.document.createElement("script");e.src=o[t],e.type="text/javascript",e.async=!1,e.charset="utf-8",m.appendChild(e)}}}));
